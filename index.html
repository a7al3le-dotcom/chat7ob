<!-- Ø§Ù„Ù…Ù„Ù: index.html (Ø§Ù„Ø¬Ø²Ø¡ 1 Ù…Ù† 2) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„ØµÙˆØªÙŠØ©</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Emoji Button -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>

  <style>
    body { font-family: sans-serif; background: #f2f2f2; margin: 0; padding: 15px; }
    h2 { text-align: center; color: #333; margin-bottom: 10px; }
    #login { text-align: center; margin-top: 30vh; }
    #chat-container { display: none; }
    #chat-box {
      background: #fff; border: 1px solid #ccc; border-radius: 8px;
      padding: 10px; height: 40vh; overflow-y: auto; margin-bottom: 10px;
    }
    .message {
      background: #e9f5ff; border-radius: 6px; padding: 10px;
      margin-bottom: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }
    .username { font-weight: bold; font-size: 16px; color: #005a9c; margin-bottom: 5px; }
    .text { font-size: 14px; color: #000; margin-bottom: 5px; word-wrap: break-word; }
    .timestamp { font-size: 12px; color: #777; text-align: left; }
    #input-area { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="text"] {
      flex: 1; padding: 10px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 6px; width: 100%;
    }
    button {
      padding: 10px 16px; font-size: 14px; background: #0078d4;
      color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    button:hover { background: #005a9c; }
    #emoji-button {
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      font-size: 20px; cursor: pointer; padding: 5px 10px;
    }
    #voice-controls {
      display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;
    }
    select, .voice-btn {
      padding: 8px; font-size: 14px; border-radius: 6px;
      border: 1px solid #ccc; cursor: pointer;
    }
    .voice-btn { background: #eee; }
    .voice-btn.active { background: #0078d4; color: white; }
    audio { display: block; margin-top: 10px; width: 100%; }
  </style>
</head>
<body>

  <div id="login">
    <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
    <p>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡:</p>
    <input type="text" id="username-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <br /><br />
    <button onclick="startChat()">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <div id="chat-container">
    <h2>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø²ÙˆØ§Ø±</h2>
    <div id="chat-box"></div>
    <div id="input-area">
      <button id="emoji-button">ğŸ˜Š</button>
      <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." />
      <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div id="voice-controls">
      <select id="mic-select"></select>
      <button class="voice-btn" onclick="toggleMic()">ğŸ™ï¸ ØªØ´ØºÙŠÙ„/ÙƒØªÙ…</button>
      <button class="voice-btn" onclick="muteAll()">ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
      <button class="voice-btn" onclick="raiseHand()">âœ‹ Ø±ÙØ¹ Ø§Ù„ÙŠØ¯</button>
    </div>

    <audio id="remote-audio" autoplay></audio>
  </div>
  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ)
    const firebaseConfig = {
      apiKey: "AIzaSyDAxLtHcIDePIeT--h9bS-yTz7OYPxzTik",
      authDomain: "my-chat-app-1d0e8.firebaseapp.com",
      databaseURL: "https://my-chat-app-1d0e8-default-rtdb.firebaseio.com",
      projectId: "my-chat-app-1d0e8",
      storageBucket: "my-chat-app-1d0e8.firebasestorage.app",
      messagingSenderId: "602134283299",
      appId: "602134283299:web:2756df0a8d8beaaaea9d96"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let localStream;
    let micEnabled = true;
    let peerConnection;
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('message-input');
    const emojiBtn = document.getElementById('emoji-button');
    const micSelect = document.getElementById('mic-select');
    const remoteAudio = document.getElementById('remote-audio');

    function startChat() {
      const inputName = document.getElementById('username-input');
      if (inputName.value.trim()) {
        username = inputName.value.trim();
        document.getElementById('login').style.display = 'none';
        document.getElementById('chat-container').style.display = 'block';
        listenForMessages();
        loadMicDevices();
        startVoice();
      }
    }

    function sendMessage() {
      const text = input.value.trim();
      if (text) {
        const now = new Date();
        const msg = {
          user: username,
          text: text,
          time: now.toLocaleString('ar-EG')
        };
        db.ref('messages').push(msg);
        input.value = '';
      }
    }

    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendMessage();
    });

    function listenForMessages() {
      db.ref('messages').on('child_added', snapshot => {
        const msg = snapshot.val();
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `<div class="username">${msg.user}</div>
                         <div class="text">${msg.text}</div>
                         <div class="timestamp">${msg.time}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    const picker = new EmojiButton({ position: 'top-end', theme: 'auto' });
    emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
    picker.on('emoji', emoji => { input.value += emoji; input.focus(); });

    async function loadMicDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const mics = devices.filter(d => d.kind === 'audioinput');
      micSelect.innerHTML = '';
      mics.forEach(mic => {
        const option = document.createElement('option');
        option.value = mic.deviceId;
        option.textContent = mic.label || `Ù…Ø§ÙŠÙƒ ${micSelect.length + 1}`;
        micSelect.appendChild(option);
      });
    }

    async function startVoice() {
      const selectedMic = micSelect.value;
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: selectedMic ? { exact: selectedMic } : undefined }
      });

      peerConnection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.ontrack = event => {
        remoteAudio.srcObject = event.streams[0];
      };

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          db.ref('signals/' + username).push({ candidate: event.candidate });
        }
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      db.ref('signals/' + username).push({ offer: offer });
    }

    db.ref('signals').on('child_added', async snapshot => {
      const data = snapshot.val();
      if (data.answer && peerConnection.signalingState !== 'stable') {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
      if (data.candidate) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (e) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ICE:', e);
        }
      }
    });

    function toggleMic() {
      micEnabled = !micEnabled;
      if (localStream) {
        localStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
      }
    }

    function muteAll() {
      db.ref('control').set({ muteAll: true });
    }

    function raiseHand() {
      db.ref('messages').push({
        user: username,
        text: 'âœ‹ Ø±ÙØ¹ Ø§Ù„ÙŠØ¯',
        time: new Date().toLocaleString('ar-EG')
      });
    }

    db.ref('control').on('value', snapshot => {
      const control = snapshot.val();
      if (control && control.muteAll && localStream) {
        localStream.getAudioTracks().forEach(track => track.enabled = false);
      }
    });
  </script>

</body>
</html>
